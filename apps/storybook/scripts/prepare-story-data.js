
const fs = require('fs');
const path = require('path');

const FONT_SOURCE_PATH = path.resolve(__dirname, '../../../primitives/tmp.json');
const LINE_HEIGHT_PATH = path.resolve(__dirname, '../../../primitives/tmp-line-height.json');
const OUTPUT_DIR = path.resolve(__dirname, '../stories/generated');
const OUTPUT_MODULE = path.join(OUTPUT_DIR, 'typographyScale.js');

const ensureDir = (dir) => {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
};

const stripUnits = (value, unit) => {
  if (!value.endsWith(unit)) return Number.NaN;
  return parseFloat(value.replace(unit, ''));
};

const formatPx = (pxValue) => {
  if (Number.isNaN(pxValue)) return null;
  const rounded = Number(pxValue.toFixed(3));
  return `${Number.isInteger(rounded) ? rounded.toFixed(0) : rounded}px`;
};

const fontSource = JSON.parse(fs.readFileSync(FONT_SOURCE_PATH, 'utf-8'));
const fontEntries = Object.entries(fontSource.typography['font-size']).map(([token, { value }]) => {
  const rem = value;
  const remNumber = stripUnits(value, 'rem');
  const px = formatPx(remNumber * 16);
  return { token, rem, px };
});

const lineHeightSource = fs.existsSync(LINE_HEIGHT_PATH)
  ? JSON.parse(fs.readFileSync(LINE_HEIGHT_PATH, 'utf-8'))
  : { typography: { 'line-height': {} } };
const lineHeightEntries = Object.entries(lineHeightSource.typography['line-height']).map(([token, { value }]) => ({
  token,
  value,
  number: Number.parseFloat(value)
}));

const fallbackLineHeight = lineHeightEntries[lineHeightEntries.length - 1] ?? { token: null, value: null, number: Number.NaN };
const resolvedLineHeights = fontEntries.map((_, index) => {
  const entry = lineHeightEntries[index] ?? fallbackLineHeight;
  return { token: entry.token, value: entry.value, number: entry.number };
});

const typographyScale = fontEntries.map((fontEntry, index) => {
  const lineEntry = resolvedLineHeights[index] ?? fallbackLineHeight;
  return {
    ...fontEntry,
    lineHeightToken: lineEntry.token,
    lineHeight: lineEntry.value
  };
});

const serialise = (data) => JSON.stringify(data, null, 2);

const fileContents = `// Auto-generated by scripts/prepare-story-data.js
export const fontSizes = ${serialise(fontEntries)};
export const lineHeights = ${serialise(resolvedLineHeights)};
export const typographyScale = ${serialise(typographyScale)};
export default { fontSizes, lineHeights, typographyScale };
`;

ensureDir(OUTPUT_DIR);
fs.writeFileSync(OUTPUT_MODULE, fileContents);
console.log('âœ… Generated stories/generated/typographyScale.js');
