<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Token Release Workflow — Figma to CDN</title>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>

    <style>
      :root {
        --bg: #0b0d12;
        --panel: #0f1420;
        --muted: #9aa4b2;
        --text: #e5e7eb;
        --stroke: #2b3445;
        --accent: #60a5fa;
        --good: #34d399;
        --warn: #fbbf24;
      }
      html,
      body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden;
        max-width: none;
        box-sizing: border-box;
        background: var(--bg);
        color: var(--text);
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
      }
      * {
        box-sizing: border-box;
      }

      .wrap {
        width: 100vw;
        height: 100vh;
        max-width: none;
        display: grid;
        grid-template-columns: 1.35fr 0.65fr;
        gap: 16px;
        padding: 16px;
        box-sizing: border-box;
        margin: 0;
      }
      .wrap.right-collapsed {
        grid-template-columns: 1fr;
        padding: 0;
        gap: 0;
        width: 100vw;
        max-width: none;
      }
      .left {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid var(--stroke);
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        width: 100%;
        height: 100%;
        max-width: none;
        min-width: 0;
      }
      .wrap.right-collapsed .left {
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-top: none;
        width: 100vw;
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        gap: 12px;
        flex-wrap: wrap;
        position: relative;
        z-index: 10;
      }
      .title {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
        flex: 1;
      }
      .title h1 {
        font-size: 14px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .title p {
        font-size: 12px;
        margin: 0;
        color: var(--muted);
      }
      .btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-left: auto;
        position: relative;
        z-index: 11;
      }
      button {
        appearance: none;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
        position: relative;
        z-index: 12;
        pointer-events: auto;
        touch-action: manipulation;
        min-height: 36px;
        min-width: 44px;
      }
      button:hover {
        border-color: rgba(96, 165, 250, 0.8);
      }
      button:active {
        transform: scale(0.98);
      }
      .svgWrap {
        position: absolute;
        inset: 58px 0 0 0;
        overflow: auto;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .right {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .rightHeader {
        padding: 12px 14px;
        border-bottom: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .rightHeaderContent {
        flex: 1;
      }
      .toggleBtn {
        appearance: none;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        flex-shrink: 0;
      }
      .toggleBtn:hover {
        border-color: rgba(96, 165, 250, 0.8);
      }
      .right.collapsed {
        display: none;
      }
      .card {
        padding: 14px;
        overflow: auto;
      }
      .card h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      .pillRow {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 8px 0 12px;
      }
      .pill {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.02);
      }
      .pill.accent {
        border-color: rgba(96, 165, 250, 0.6);
        color: rgba(96, 165, 250, 0.95);
      }
      .pill.good {
        border-color: rgba(52, 211, 153, 0.6);
        color: rgba(52, 211, 153, 0.95);
      }
      .pill.warn {
        border-color: rgba(251, 191, 36, 0.6);
        color: rgba(251, 191, 36, 0.95);
      }

      .section {
        margin-top: 14px;
        padding-top: 12px;
        border-top: 1px dashed rgba(255, 255, 255, 0.12);
      }
      .section h4 {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      ul {
        margin: 0 0 0 18px;
        padding: 0;
        line-height: 1.5;
        font-size: 13px;
        color: var(--text);
      }
      li {
        margin: 6px 0;
      }

      /* Graph styling */
      svg {
        width: 100%;
        height: 100%;
        pointer-events: auto;
      }

      .node {
        cursor: pointer;
        pointer-events: auto;
      }
      .node rect {
        rx: 12px;
        ry: 12px;
        fill: rgba(255, 255, 255, 0.03);
        stroke: rgba(255, 255, 255, 0.16);
        stroke-width: 1.3px;
        pointer-events: auto;
      }
      .node.selected rect {
        stroke: rgba(96, 165, 250, 0.95);
        stroke-width: 2.4px;
      }
      .node text {
        fill: var(--text);
        font-weight: 650;
        font-size: 12px;
        pointer-events: none;
        user-select: none;
      }
      .node:hover rect {
        stroke: rgba(96, 165, 250, 0.6);
        stroke-width: 2px;
      }

      .cluster rect {
        fill: rgba(255, 255, 255, 0.02);
        stroke: rgba(255, 255, 255, 0.12);
        stroke-width: 1.2px;
        rx: 14px;
        ry: 14px;
      }
      .cluster text {
        fill: rgba(229, 231, 235, 0.85);
        font-weight: 700;
        font-size: 12px;
        letter-spacing: 0.02em;
      }

      .edgePath path {
        stroke: rgba(255, 255, 255, 0.22);
        stroke-width: 1.4px;
        fill: none;
      }
      .edgeLabel text {
        fill: rgba(255, 255, 255, 0.6);
        font-size: 10px;
      }

      .edgePath.strong path {
        stroke: rgba(96, 165, 250, 0.55);
        stroke-width: 2.1px;
      }
      .edgePath.dashed path {
        stroke-dasharray: 6 5;
        opacity: 0.95;
      }
      .edgePath.success path {
        stroke: rgba(52, 211, 153, 0.55);
        stroke-width: 2px;
      }

      @media (max-width: 768px) {
        .toolbar {
          padding: 10px 12px;
          gap: 10px;
        }
        .title {
          min-width: 0;
          width: 100%;
        }
        .title p {
          font-size: 11px;
        }
        .btns {
          width: 100%;
          margin-left: 0;
          margin-top: 8px;
          justify-content: flex-start;
        }
        button {
          flex: 1;
          min-width: 0;
          font-size: 11px;
          padding: 10px 8px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="left">
        <div class="toolbar">
          <div class="title">
            <h1>Token Release Workflow — Figma to CDN</h1>
            <p>
              Detailed workflow: Designer CRUD in Figma → GitHub Actions GUI
              release → REST API export → W3C JSON → Style Dictionary transforms
              → Versioning → CDN → Consumption.
            </p>
          </div>
          <div class="btns">
            <button id="btnCenter">Center view</button>
            <button id="btnReset">Reset selection</button>
            <button id="togglePanel" class="toggleBtn" title="Toggle panel">
              Panel
            </button>
          </div>
        </div>

        <div class="svgWrap">
          <svg id="svg"><g id="g"></g></svg>
        </div>
      </div>

      <div class="right" id="rightPanel">
        <div class="rightHeader">
          <div class="rightHeaderContent">
            <h2 id="panelTitle">Step details</h2>
            <p id="panelSubtitle">
              Click any node to see what happens there (inputs, outputs, tools,
              owners).
            </p>
          </div>
        </div>
        <div class="card" id="panel"></div>
      </div>
    </div>

    <script>
      // Wait for DOM to be ready
      document.addEventListener("DOMContentLoaded", function() {
      // -----------------------------
      // Nodes: Token Release Workflow
      // -----------------------------
      const nodes = {
        // Designer workflow
        designerCRUD: {
          title: "Designer CRUD Operations\n(Figma Variables UI)",
          pills: ["Designer", "Figma UI", "Create/Update/Delete"],
          owns: [
            "Create new variables in Figma Variable Collections",
            "Update existing variable values (colors, spacing, typography)",
            "Delete deprecated variables",
            "Organize variables by collection (Primitives, Semantic, Component)",
            "Set up modes (light/dark, responsive breakpoints)",
            "Link semantic tokens to primitives via aliases",
          ],
          tools: [
            "Figma Variables UI (Shift+Cmd/Ctrl+K)",
            "Figma Variable Collections",
            "Figma Modes",
          ],
          outputs: [
            "Updated Variable Collections in Figma file",
            "Organized token structure ready for export",
          ],
        },

        // GitHub Actions GUI
        githubActionsGUI: {
          title: "GitHub Actions Workflow\n(GUI Release Trigger)",
          pills: ["Release", "GUI", "Semver"],
          owns: [
            "Open GitHub Actions workflow dispatch UI",
            "Select release type: major, minor, or patch (semver)",
            "Optionally add release notes or changelog",
            "Trigger workflow_dispatch event",
            "Validate inputs and permissions",
          ],
          tools: [
            "GitHub Actions UI",
            "workflow_dispatch event",
            "Input parameters (release_type, notes)",
          ],
          outputs: [
            "Workflow trigger event",
            "Release type selection (major/minor/patch)",
            "Release metadata",
          ],
        },

        // Figma REST API Export
        figmaRestExport: {
          title: "Export Tokens\n(Figma REST API)",
          pills: ["API", "Export", "Automation"],
          owns: [
            "Authenticate with Figma REST API using personal access token",
            "Call GET /v1/files/{fileId}/variables/local endpoint",
            "Fetch all variable collections and their variables",
            "Handle pagination if needed",
            "Parse API response structure",
            "Extract variables, collections, and modes",
          ],
          tools: [
            "Figma REST API v1",
            "Personal Access Token (FIGMA_REST_API)",
            "GitHub Actions secrets",
            "API client library or curl/HTTP requests",
          ],
          outputs: [
            "Raw Figma API response (JSON)",
            "Variable collections data",
            "All variables with values and aliases",
          ],
        },

        // W3C JSON Transformation
        w3cJSON: {
          title: "W3C Design Tokens JSON\n(Transform Structure)",
          pills: ["W3C Spec", "JSON", "Standard"],
          owns: [
            "Transform Figma variable structure to W3C Design Tokens format",
            "Map Figma collections to W3C token groups",
            "Convert variable values to W3C token format",
            "Handle aliases/references between tokens",
            "Generate $schema reference to W3C spec",
            "Create token metadata (description, type, etc.)",
          ],
          tools: [
            "W3C Design Tokens Format spec",
            "Custom transformation scripts",
            "JSON schema validation",
          ],
          outputs: [
            "W3C-compliant design tokens JSON",
            "Token groups and properties",
            "Schema-validated structure",
          ],
        },

        // Style Dictionary Transforms
        styleDictionary: {
          title: "Style Dictionary Transforms\n(CSS, Tailwind, Android)",
          pills: ["Transforms", "Multi-platform", "Bundles"],
          owns: [
            "Load W3C JSON tokens into Style Dictionary",
            "Apply platform-specific transforms",
            "Generate CSS custom properties output",
            "Generate Tailwind config format",
            "Generate Android XML/values format",
            "Handle platform-specific naming conventions",
          ],
          tools: [
            "Style Dictionary library",
            "Custom transform functions",
            "Platform-specific formatters",
          ],
          outputs: [
            "CSS custom properties file",
            "Tailwind config JSON",
            "Android values XML",
            "Platform-specific token bundles",
          ],
        },

        // CSS Output Example
        cssOutput: {
          title: "CSS Custom Properties\n(Example Output)",
          pills: ["CSS", "Output", "Example"],
          owns: [
            "Generate CSS variables from tokens",
            "Format: --token-name: value;",
            "Organize by token group/namespace",
            "Include comments with token metadata",
          ],
          tools: ["Style Dictionary CSS formatter"],
          outputs: [
            "tokens.css file",
            "CSS custom properties ready for import",
            "Example: --color-primary-500: #3b82f6;",
          ],
        },

        // Tailwind Output Example
        tailwindOutput: {
          title: "Tailwind Config Format\n(Example Output)",
          pills: ["Tailwind", "Output", "Example"],
          owns: [
            "Generate Tailwind theme configuration",
            "Map tokens to Tailwind theme keys",
            "Format: theme: { colors: { primary: {...} } }",
            "Support nested token structures",
          ],
          tools: ["Style Dictionary Tailwind formatter"],
          outputs: [
            "tailwind.tokens.js file",
            "Tailwind-compatible theme config",
            "Example: colors: { primary: { 500: '#3b82f6' } }",
          ],
        },

        // Android Output Example
        androidOutput: {
          title: "Android Values XML\n(Example Output)",
          pills: ["Android", "Output", "Example"],
          owns: [
            "Generate Android resource values XML",
            "Format: <color name=\"token_name\">value</color>",
            "Organize by resource type (colors, dimensions, etc.)",
            "Handle Android naming conventions",
          ],
          tools: ["Style Dictionary Android formatter"],
          outputs: [
            "values/tokens.xml file",
            "Android resource values",
            "Example: <color name=\"primary_500\">#3b82f6</color>",
          ],
        },

        // Versioning - CSS
        versioningCSS: {
          title: "Version CSS Package\n(Semver + NPM)",
          pills: ["Versioning", "CSS", "Package"],
          owns: [
            "Apply semver version based on release type",
            "Create CSS-specific NPM package",
            "Package CSS custom properties file",
            "Tag git commit with version",
            "Generate CSS package changelog",
          ],
          tools: [
            "npm version command",
            "NPM package.json (CSS package)",
            "Git tags",
          ],
          outputs: [
            "CSS package version (e.g., @org/tokens-css@1.2.3)",
            "package.json with CSS package metadata",
            "Git tag (v1.2.3-css)",
            "CSS distribution artifact",
          ],
        },

        // Versioning - Tailwind
        versioningTailwind: {
          title: "Version Tailwind Package\n(Semver + NPM)",
          pills: ["Versioning", "Tailwind", "Package"],
          owns: [
            "Apply semver version based on release type",
            "Create Tailwind-specific NPM package",
            "Package Tailwind config file",
            "Tag git commit with version",
            "Generate Tailwind package changelog",
          ],
          tools: [
            "npm version command",
            "NPM package.json (Tailwind package)",
            "Git tags",
          ],
          outputs: [
            "Tailwind package version (e.g., @org/tokens-tailwind@1.2.3)",
            "package.json with Tailwind package metadata",
            "Git tag (v1.2.3-tailwind)",
            "Tailwind distribution artifact",
          ],
        },

        // Versioning - Android
        versioningAndroid: {
          title: "Version Android Package\n(Semver + Maven)",
          pills: ["Versioning", "Android", "Maven"],
          owns: [
            "Apply semver version based on release type",
            "Create Android library module (AAR)",
            "Package Android values XML in res/values/",
            "Generate Maven POM file",
            "Tag git commit with version",
            "Generate Android package changelog",
          ],
          tools: [
            "Gradle build system",
            "Maven POM generation",
            "Android library plugin",
            "Git tags",
          ],
          outputs: [
            "Android library version (e.g., com.org:tokens-android:1.2.3)",
            "AAR file with resources",
            "Maven POM metadata",
            "Git tag (v1.2.3-android)",
            "Android distribution artifact",
          ],
        },

        // CDN Distribution - CSS
        cdnCSS: {
          title: "CDN Distribution — CSS\n(Public Access)",
          pills: ["CDN", "CSS", "Public"],
          owns: [
            "Upload CSS package to CDN",
            "Organize by version in CDN structure",
            "Make CSS tokens accessible via public URLs",
            "Set appropriate cache headers",
            "Provide versioned and latest endpoints",
          ],
          tools: [
            "CDN service (e.g., jsDelivr, unpkg, custom CDN)",
            "File upload/CI integration",
            "CDN configuration",
          ],
          outputs: [
            "CDN URL for CSS (e.g., /v1.2.3/tokens.css)",
            "Latest CSS URL (e.g., /latest/tokens.css)",
            "Public access to CSS token file",
          ],
        },

        // CDN Distribution - Tailwind
        cdnTailwind: {
          title: "CDN Distribution — Tailwind\n(Public Access)",
          pills: ["CDN", "Tailwind", "Public"],
          owns: [
            "Upload Tailwind package to CDN",
            "Organize by version in CDN structure",
            "Make Tailwind tokens accessible via public URLs",
            "Set appropriate cache headers",
            "Provide versioned and latest endpoints",
          ],
          tools: [
            "CDN service (e.g., jsDelivr, unpkg, custom CDN)",
            "File upload/CI integration",
            "CDN configuration",
          ],
          outputs: [
            "CDN URL for Tailwind (e.g., /v1.2.3/tailwind.tokens.js)",
            "Latest Tailwind URL (e.g., /latest/tailwind.tokens.js)",
            "Public access to Tailwind token file",
          ],
        },

        // Maven Distribution - Android
        mavenAndroid: {
          title: "Maven Repository Distribution\n(Android)",
          pills: ["Maven", "Android", "Repository"],
          owns: [
            "Publish AAR to Maven repository",
            "Upload to Maven Central, JitPack, or private Maven repo",
            "Organize by groupId:artifactId:version",
            "Make Android tokens accessible via Gradle dependency",
            "Set repository metadata and coordinates",
          ],
          tools: [
            "Maven repository (Maven Central, JitPack, private repo)",
            "Gradle publish plugin",
            "Maven deploy plugin",
            "Repository credentials",
          ],
          outputs: [
            "Maven coordinates (e.g., com.org:tokens-android:1.2.3)",
            "Maven repository URL",
            "AAR and POM files in Maven repo",
            "Gradle dependency reference",
          ],
        },

        // Consumer Usage - CSS
        consumerCSS: {
          title: "Consumer Usage — CSS\n(Import & Use)",
          pills: ["Consumption", "CSS", "Usage"],
          owns: [
            "Import CSS tokens via NPM or CDN",
            "Use CSS custom properties in stylesheets",
            "Reference tokens in CSS: var(--color-primary-500)",
            "Access tokens at build time or runtime",
          ],
          tools: [
            "npm install @org/tokens-css",
            "CDN link: <link href='cdn/v1.2.3/tokens.css'>",
            "Build tools (webpack, vite, etc.)",
            "Framework integration",
          ],
          outputs: [
            "Integrated CSS tokens in application",
            "Consistent design values via CSS variables",
            "Automatic updates via version pinning",
          ],
        },

        // Consumer Usage - Tailwind
        consumerTailwind: {
          title: "Consumer Usage — Tailwind\n(Import & Use)",
          pills: ["Consumption", "Tailwind", "Usage"],
          owns: [
            "Import Tailwind tokens via NPM or CDN",
            "Import Tailwind config in tailwind.config.js",
            "Use tokens in Tailwind classes: bg-primary-500",
            "Access tokens at build time",
          ],
          tools: [
            "npm install @org/tokens-tailwind",
            "CDN import or local file",
            "Tailwind config extension",
            "Build tools (webpack, vite, etc.)",
          ],
          outputs: [
            "Integrated Tailwind tokens in application",
            "Consistent design values via Tailwind theme",
            "Automatic updates via version pinning",
          ],
        },

        // Consumer Usage - Android
        consumerAndroid: {
          title: "Consumer Usage — Android\n(Import & Use)",
          pills: ["Consumption", "Android", "Usage"],
          owns: [
            "Add Maven dependency in build.gradle",
            "Reference Android values in XML layouts",
            "Use tokens in Android resources: @color/primary_500",
            "Access tokens at build time via Gradle",
          ],
          tools: [
            "Gradle dependency: implementation 'com.org:tokens-android:1.2.3'",
            "Android Gradle build system",
            "Android Studio integration",
            "Maven repository access",
          ],
          outputs: [
            "Integrated Android tokens in application",
            "Consistent design values via Android resources",
            "Automatic updates via version pinning",
          ],
        },
      };

      // -----------------------------
      // Edges: Workflow connections
      // -----------------------------
      const edges = [
        {
          from: "designerCRUD",
          to: "githubActionsGUI",
          label: "ready to release",
          cls: "dashed",
        },
        {
          from: "githubActionsGUI",
          to: "figmaRestExport",
          label: "trigger workflow",
          cls: "strong",
        },
        {
          from: "figmaRestExport",
          to: "w3cJSON",
          label: "transform to W3C",
          cls: "strong",
        },
        {
          from: "w3cJSON",
          to: "styleDictionary",
          label: "load tokens",
          cls: "strong",
        },
        {
          from: "styleDictionary",
          to: "cssOutput",
          label: "generate CSS",
          cls: "success",
        },
        {
          from: "styleDictionary",
          to: "tailwindOutput",
          label: "generate Tailwind",
          cls: "success",
        },
        {
          from: "styleDictionary",
          to: "androidOutput",
          label: "generate Android",
          cls: "success",
        },
        {
          from: "cssOutput",
          to: "versioningCSS",
          label: "package CSS",
          cls: "strong",
        },
        {
          from: "tailwindOutput",
          to: "versioningTailwind",
          label: "package Tailwind",
          cls: "strong",
        },
        {
          from: "androidOutput",
          to: "versioningAndroid",
          label: "package Android",
          cls: "strong",
        },
        {
          from: "versioningCSS",
          to: "cdnCSS",
          label: "upload to CDN",
          cls: "strong",
        },
        {
          from: "versioningTailwind",
          to: "cdnTailwind",
          label: "upload to CDN",
          cls: "strong",
        },
        {
          from: "versioningAndroid",
          to: "mavenAndroid",
          label: "publish to Maven",
          cls: "strong",
        },
        {
          from: "cdnCSS",
          to: "consumerCSS",
          label: "consume via CDN/NPM",
          cls: "success",
        },
        {
          from: "cdnTailwind",
          to: "consumerTailwind",
          label: "consume via CDN/NPM",
          cls: "success",
        },
        {
          from: "mavenAndroid",
          to: "consumerAndroid",
          label: "consume via Gradle",
          cls: "success",
        },
      ];

      // -----------------------------
      // Graph setup
      // -----------------------------
      const g = new dagreD3.graphlib.Graph({ multigraph: true, compound: true })
        .setGraph({
          rankdir: "LR",
          nodesep: 50,
          ranksep: 80,
          marginx: 24,
          marginy: 22,
        })
        .setDefaultEdgeLabel(() => ({}));

      // Clusters
      g.setNode("clusterDesign", {
        label: "1) Design Phase",
        clusterLabelPos: "top",
        padding: 12,
      });
      g.setNode("clusterRelease", {
        label: "2) Release Trigger",
        clusterLabelPos: "top",
        padding: 12,
      });
      g.setNode("clusterExport", {
        label: "3) Export & Transform",
        clusterLabelPos: "top",
        padding: 12,
      });
      g.setNode("clusterGenerate", {
        label: "4) Platform Generation",
        clusterLabelPos: "top",
        padding: 12,
      });
      g.setNode("clusterDistribute", {
        label: "5) Distribution",
        clusterLabelPos: "top",
        padding: 12,
      });
      g.setNode("clusterConsume", {
        label: "6) Consumption",
        clusterLabelPos: "top",
        padding: 12,
      });

      // Add nodes
      Object.entries(nodes).forEach(([id, n]) => {
        const base =
          "fill: rgba(255,255,255,0.03); stroke: rgba(255,255,255,0.16); stroke-width: 1.3px;";
        const primary = [
          "githubActionsGUI",
          "figmaRestExport",
          "w3cJSON",
          "styleDictionary",
          "versioningCSS",
          "versioningTailwind",
          "versioningAndroid",
          "cdnCSS",
          "cdnTailwind",
          "mavenAndroid",
        ].includes(id);
        const style = primary
          ? base + " stroke: rgba(96,165,250,0.55);"
          : base;
        g.setNode(id, {
          label: n.title,
          rx: 12,
          ry: 12,
          padding: 14,
          style,
        });
      });

      // Assign parents (clusters)
      g.setParent("designerCRUD", "clusterDesign");
      g.setParent("githubActionsGUI", "clusterRelease");
      g.setParent("figmaRestExport", "clusterExport");
      g.setParent("w3cJSON", "clusterExport");
      g.setParent("styleDictionary", "clusterGenerate");
      g.setParent("cssOutput", "clusterGenerate");
      g.setParent("tailwindOutput", "clusterGenerate");
      g.setParent("androidOutput", "clusterGenerate");
      g.setParent("versioningCSS", "clusterDistribute");
      g.setParent("versioningTailwind", "clusterDistribute");
      g.setParent("versioningAndroid", "clusterDistribute");
      g.setParent("cdnCSS", "clusterDistribute");
      g.setParent("cdnTailwind", "clusterDistribute");
      g.setParent("mavenAndroid", "clusterDistribute");
      g.setParent("consumerCSS", "clusterConsume");
      g.setParent("consumerTailwind", "clusterConsume");
      g.setParent("consumerAndroid", "clusterConsume");

      // Add edges
      edges.forEach((e, i) => {
        try {
          g.setEdge(
            e.from,
            e.to,
            {
              label: e.label,
              class: e.cls || "",
              arrowhead: "vee",
              lineInterpolate: "basis",
            },
            `e${i}`,
          );
        } catch (error) {
          console.error(`Error adding edge from ${e.from} to ${e.to}:`, error);
        }
      });

      // -----------------------------
      // Render + interactivity
      // -----------------------------
      const svg = d3.select("#svg");
      const inner = d3.select("#g");
      const render = new dagreD3.render();

      const zoom = d3
        .zoom()
        .scaleExtent([0.5, 1.35])
        .on("zoom", (event) => inner.attr("transform", event.transform));

      svg.call(zoom);
      
      try {
        render(inner, g);
      } catch (error) {
        console.error("Error rendering graph:", error);
      }

      function centerView() {
        try {
          const graphWidth = g.graph().width;
          const svgWidth = svg.node().clientWidth;
          if (graphWidth && svgWidth) {
            const scale = 0.85;
            const tx = Math.max(16, (svgWidth - graphWidth * scale) / 2);
            const ty = 28;

            svg
              .transition()
              .duration(350)
              .call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
          }
        } catch (error) {
          console.error("Error centering view:", error);
        }
      }
      
      // Center view after render
      requestAnimationFrame(() => {
        centerView();
      });

      // Right panel
      const panel = d3.select("#panel");
      const panelTitle = d3.select("#panelTitle");
      const panelSubtitle = d3.select("#panelSubtitle");

      function setPanel(id) {
        const n = nodes[id];
        if (!n) return;

        panelTitle.text(n.title.split("\n")[0]);
        panelSubtitle.text("Inputs/Outputs/Tools/Owners for this step.");

        panel.html("");
        panel.append("h3").text(n.title.split("\n")[0]);

        const pills = panel.append("div").attr("class", "pillRow");
        (n.pills || []).forEach((p, idx) => {
          const cls =
            idx === 0 ? "pill accent" : idx === 1 ? "pill good" : "pill warn";
          pills.append("span").attr("class", cls).text(p);
        });

        const s1 = panel.append("div").attr("class", "section");
        s1.append("h4").text("What happens here");
        const ul1 = s1.append("ul");
        (n.owns || []).forEach((x) => ul1.append("li").text(x));

        const s2 = panel.append("div").attr("class", "section");
        s2.append("h4").text("Tools / Systems");
        const ul2 = s2.append("ul");
        (n.tools || []).forEach((x) => ul2.append("li").text(x));

        const s3 = panel.append("div").attr("class", "section");
        s3.append("h4").text("Outputs / Artifacts");
        const ul3 = s3.append("ul");
        (n.outputs || []).forEach((x) => ul3.append("li").text(x));
      }

      function clearSelection() {
        inner.selectAll("g.node").classed("selected", false);
      }

      inner
        .selectAll("g.node")
        .style("cursor", "pointer")
        .on("click", function (event, id) {
          clearSelection();
          d3.select(this).classed("selected", true);
          setPanel(id);
        });

      // Default selection
      inner
        .selectAll("g.node")
        .filter((d) => d === "designerCRUD")
        .classed("selected", true);
      setPanel("designerCRUD");

      // Buttons
      d3.select("#btnCenter").on("click", centerView);
      d3.select("#btnReset").on("click", () => {
        clearSelection();
        inner
          .selectAll("g.node")
          .filter((d) => d === "designerCRUD")
          .classed("selected", true);
        setPanel("designerCRUD");
        centerView();
      });

      // Panel toggle
      const rightPanel = d3.select("#rightPanel");
      const wrap = d3.select(".wrap");
      const toggleBtn = d3.select("#togglePanel");

      function updateToggleButton() {
        const isCollapsed = rightPanel.classed("collapsed");
        toggleBtn.text(isCollapsed ? "Show Panel" : "Hide Panel");
        toggleBtn.attr("title", isCollapsed ? "Show panel" : "Hide panel");
      }

      toggleBtn.on("click", () => {
        const isCollapsed = rightPanel.classed("collapsed");
        rightPanel.classed("collapsed", !isCollapsed);
        wrap.classed("right-collapsed", !isCollapsed);
        updateToggleButton();
      });

      // Initialize button text
      updateToggleButton();
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
